# NestJS BullMQ with Supabase Integration

This project demonstrates how to use BullMQ with Nest.js for background job processing, integrated with Supabase for authentication and data persistence.

## Features

- üöÄ Background job processing with BullMQ
- üîê JWT Authentication with Supabase
- üìä Job progress tracking
- üìù Job logging to Supabase
- üõ°Ô∏è Protected API endpoints
- üîÑ Real-time job status updates

## Prerequisites

- Node.js (v16 or later)
- npm or yarn
- Redis server (for BullMQ)
- Supabase account (for authentication and data storage)

## Getting Started

### 1. Clone the repository

```bash
git clone <repository-url>
cd <project-directory>
```

### 2. Install dependencies

```bash
npm install
# or
yarn
```

### 3. Set up environment variables

Copy the example environment file and update the values:

```bash
cp .env.example .env
```

Edit the `.env` file with your configuration:

```env
# Supabase Configuration
SUPABASE_URL=your_supabase_project_url
SUPABASE_KEY=your_supabase_anon_public_key

# JWT Configuration
JWT_SECRET=your_jwt_secret_key_change_this_in_production

# Redis Configuration (for BullMQ)
REDIS_HOST=localhost
REDIS_PORT=6379

# App Configuration
PORT=3000
NODE_ENV=development
```

### 4. Set up Supabase

1. Create a new project at [Supabase](https://supabase.com/)
2. Go to Project Settings > API to find your `SUPABASE_URL` and `SUPABASE_KEY`
3. Create a `job_logs` table with the following SQL:

```sql
create table public.job_logs (
  id bigint generated by default as identity primary key,
  user_id uuid references auth.users not null,
  job_id text not null,
  status text not null,
  progress integer default 0,
  metadata jsonb default '{}'::jsonb,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  updated_at timestamp with time zone default timezone('utc'::text, now()) not null,
  constraint job_logs_user_id_job_id_key unique (user_id, job_id)
);

-- Enable RLS
alter table public.job_logs enable row level security;

-- Create policies for RLS
create policy "Users can view their own job logs"
  on public.job_logs for select
  using (auth.uid() = user_id);

create policy "Users can insert their own job logs"
  on public.job_logs for insert
  with check (auth.uid() = user_id);

create policy "Users can update their own job logs"
  on public.job_logs for update
  using (auth.uid() = user_id);
```

### 5. Start Redis

Make sure you have Redis running locally:

```bash
# On macOS (using Homebrew)
brew services start redis

# On Linux
sudo service redis-server start

# Or using Docker
docker run --name redis -p 6379:6379 -d redis
```

### 6. Start the application

```bash
# Development
npm run start:dev

# Production
npm run build
npm run start:prod
```

## API Endpoints

### Public Endpoints

- `GET /` - Health check

### Protected Endpoints (Requires JWT Authentication)

- `POST /transcode` - Start a new transcode job
- `GET /profile` - Get current user profile

## Authentication

This application uses JWT tokens from Supabase for authentication. To authenticate requests:

1. Get a JWT token from Supabase Auth
2. Include it in the `Authorization` header:
   ```
   Authorization: Bearer <your-jwt-token>
   ```

## Running Tests

```bash
# Unit tests
npm run test

# E2E tests
npm run test:e2e

# Test coverage
npm run test:cov
```

## Deployment

### Docker

```bash
docker build -t your-username/nest-bullmq .
docker run -p 3000:3000 your-username/nest-bullmq
```

### Kubernetes

See the `k8s` directory for example Kubernetes manifests.

## Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `PORT` | Port to run the server on | `3000` |
| `NODE_ENV` | Node environment | `development` |
| `SUPABASE_URL` | Your Supabase project URL | - |
| `SUPABASE_KEY` | Your Supabase anon/public key | - |
| `JWT_SECRET` | Secret for JWT verification | - |
| `REDIS_HOST` | Redis server host | `localhost` |
| `REDIS_PORT` | Redis server port | `6379` |

## License

MIT
